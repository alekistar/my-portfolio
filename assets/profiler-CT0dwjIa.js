import{Y as C,$ as N,a0 as q,_ as G,a1 as X,a2 as Y,a3 as y,y as O,a4 as $,a5 as J,U as K,a6 as R,T as Q,o as W,a7 as Z}from"./index-KoX8uUUW.js";function ee(e,t,r,a){const u=o=>{t.notify(14,{error:o}),G("Error reported to customer",{"error.message":o.message})},d=C([e.profilingEndpointBuilder],u),f=r(a);return{async send({event:o,...E}){const p=new FormData,m=N(o);if(!m)throw new Error("Failed to serialize event");p.append("event",new Blob([m],{type:"application/json"}),"event.json");let s=m.length;for(const[v,k]of q(E)){const w=N(k);if(!w)throw new Error("Failed to serialize attachment");const g=await te(f,w);s+=g.outputBytesCount,p.append(v,new Blob([g.output]),v)}d.send({data:p,bytesCount:s})}}}function te(e,t){return new Promise(r=>{e.write(t),e.finish(a=>{r(a)})})}function ne(e){let t=0;for(const r of e)r.stackId!==void 0&&t++;return t}const se=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function re(e){return e?e.replace(se,"/?"):"/"}const j=(e,t)=>e||re(t);function ae(e,t,r){const a={application:{id:t}};r&&(a.session={id:r});const{ids:u,names:d}=oe(e.views);u.length&&(a.view={id:u,name:d});const f=e.longTasks.map(o=>o.id).filter(o=>o!==void 0);return f.length&&(a.long_task={id:f}),a}function oe(e){const t={ids:[],names:[]};for(const r of e)t.ids.push(r.viewId),r.viewName&&t.names.push(r.viewName);return t.names=Array.from(new Set(t.names)),t}function ie(e,t,r){return{event:ce(e,t,r),"wall-time.json":e}}function ce(e,t,r){const a=X(t),u=ae(e,t.applicationId,r),d=le(a);return{...u,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:d.join(","),_dd:{clock_drift:Y()}}}function le(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}const ue={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function fe(e,t,r,a,u,d,f,o=ue){const E=ee(e,t,d,6);let p;const m=[];let s={state:"stopped",stateReason:"initializing"};t.subscribe(9,()=>{w("session-expired").catch(y)}),t.subscribe(10,()=>{s.state==="stopped"&&s.stateReason==="session-expired"&&v()});function v(){if(s.state==="running")return;const n=f.findView();p=n?{startClocks:n.startClocks,viewId:n.id,viewName:j(n.name,document.location.pathname)}:void 0,m.push(O(e,window,"visibilitychange",L).stop,O(e,window,"beforeunload",V).stop),h()}async function k(){await w("stopped-by-user")}async function w(n){await M(n),m.forEach(i=>i()),a.set({status:"stopped",error_reason:void 0})}function g(n){if(n.state==="running")return{cleanupTasks:n.cleanupTasks};const i=[],l=t.subscribe(2,c=>{const b={viewId:c.id,viewName:j(c.name,document.location.pathname),startClocks:c.startClocks};I(b),p=b});return i.push(l.unsubscribe),{cleanupTasks:i}}function h(){const n=$().Profiler;if(!n)throw a.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");P(s).catch(y);const{cleanupTasks:i}=g(s);let l;try{l=new n({sampleInterval:o.sampleIntervalMs,maxBufferSize:Math.round(o.collectIntervalMs*1.5/o.sampleIntervalMs)})}catch(c){c instanceof Error&&c.message.includes("disabled by Document Policy")?(J.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",c),a.set({status:"error",error_reason:"missing-document-policy-header"})):a.set({status:"error",error_reason:"unexpected-exception"});return}a.set({status:"running",error_reason:void 0}),s={state:"running",startClocks:R(),profiler:l,timeoutId:K(h,o.collectIntervalMs),views:[],cleanupTasks:i,longTasks:[]},I(p),l.addEventListener("samplebufferfull",S)}async function P(n){if(n.state!=="running")return;Q(n.timeoutId),n.profiler.removeEventListener("samplebufferfull",S);const{startClocks:i,views:l}=n;await n.profiler.stop().then(c=>{const b=R(),D=W(i.timeStamp,b.timeStamp),_=u.findLongTasks(i.relative,D),H=D<o.minProfileDurationMs,x=ne(c.samples)<o.minNumberOfSamples;_.length===0&&(H||x)||B(Object.assign(c,{startClocks:i,endClocks:b,clocksOrigin:Z(),longTasks:_,views:l,sampleInterval:o.sampleIntervalMs}))}).catch(y)}async function M(n){s.state==="running"&&(await T(),s={state:"stopped",stateReason:n})}async function A(){s.state==="running"&&(await T(),s={state:"paused"})}async function T(){s.state==="running"&&(s.cleanupTasks.forEach(n=>n()),await P(s))}function I(n){s.state!=="running"||!n||s.views.push(n)}function B(n){var i;const l=(i=r.findTrackedSession())===null||i===void 0?void 0:i.id,c=ie(n,e,l);E.send(c)}function S(){h()}function L(){document.visibilityState==="hidden"&&s.state==="running"?A().catch(y):document.visibilityState==="visible"&&s.state==="paused"&&h()}function V(){h()}function F(){return s.state==="stopped"}function U(){return s.state==="running"}function z(){return s.state==="paused"}return{start:v,stop:k,isStopped:F,isRunning:U,isPaused:z}}export{ue as DEFAULT_RUM_PROFILER_CONFIGURATION,fe as createRumProfiler};
